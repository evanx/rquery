{"version":3,"sources":["../../rquery/handlers/registerCert.js"],"names":[],"mappings":"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","file":"registerCert.js","sourcesContent":["\nconst logger = Loggers.create(module.filename);\nconst rquery = global.rquery;\n\nexport default async function registerCert(req, res, reqx) {\n   const cert = rquery.getClientCert(req);\n   if (!cert) throw new ValidationError({message: 'No client cert',\n      hint: rquery.hints.signup\n   });\n   const dn = rquery.parseCertDn(req);\n   if (!dn.ou) throw new ValidationError({message: 'No client cert OU name',\n      hint: rquery.hints.signup\n   });\n   const [matching, account, role, id] = dn.cn.split(':');\n   logger.debug('CN', matching);\n   if (!matching) {\n      throw new ValidationError({message: 'Cert CN mismatch',\n         hint: rquery.hints.signup\n      });\n   }\n   if (dn.ou !== role) {\n      throw new ValidationError({message: 'Cert OU/role mismatch',\n         hint: rquery.hints.signup\n      });\n   }\n   if (dn.o !== account) {\n      throw new ValidationError({message: 'Cert O/account mismatch',\n         hint: rquery.hints.signup\n      });\n   }\n   const accountKey = rquery.adminKey('account', account);\n   const grantKey = rquery.adminKey('telegram', 'user', account, 'grantcert');\n   const certDigest = rquery.digestPem(cert);\n   const shortDigest = certDigest.slice(-12);\n   const pemExtract = rquery.extractPem(cert);\n   const [granted, sismember] = await rquery.redis.multiExecAsync(multi => {\n      multi.get(grantKey);\n      multi.sismember(rquery.adminKey('account', account, 'certs'), certDigest);\n   });\n   if (sismember) {\n      throw new ValidationError({message: 'Cert granted', hint: rquery.hints.routes});\n   }\n   if (!granted) {\n      throw new ValidationError({message: 'Cert must be granted via @redishub_bot',\n         hint: {\n            message: [\n               `Try @redishub_bot \"/grantcert ${shortDigest}\"`,\n               `e.g. via https://web.telegram.org,`,\n            ].join(' '),\n            clipboard: `@redishub_bot /grantcert ${shortDigest}`,\n            url: `https://web.telegram.org/#/im?p=@redishub_bot#grantcert-${shortDigest}`\n         }\n      });\n   }\n   if (granted.indexOf(shortDigest) < 0 &&\n   certDigest.indexOf(granted) < 0 &&\n   pemExtract != granted) {\n      throw new ValidationError({message: 'Granted cert not matching: ' + shortDigest,\n         hint: {\n            message: `Try @redishub_bot \"/grantcert ${shortDigest}`\n            + ` from the authoritative Telegram account`\n            + ` e.g. via https://web.telegram.org`\n            ,\n            clipboard: `@redishub_bot /grantcert ${shortDigest}`,\n            url: `https://web.telegram.org/#/im?p=@redishub_bot#grantcert-${shortDigest}`\n         }\n      });\n   }\n   const [del, sadd] = await rquery.redis.multiExecAsync(multi => {\n      multi.del(grantKey);\n      multi.sadd(rquery.adminKey('account', account, 'certs'), certDigest);\n   });\n   if (!sadd) {\n      logger.debug('certs sadd');\n   }\n   if (!del) {\n      logger.warn('certs grant del');\n   }\n   return {account};\n}\n"]}
{"version":3,"sources":["../../rquery/handlers/registerCert.js"],"names":[],"mappings":"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","file":"registerCert.js","sourcesContent":["\nconst logger = Loggers.create(module.filename);\nconst rquery = global.rquery;\n\nexport default async function registerCert(req, res, reqx) {\n   const cert = rquery.getClientCert(req);\n   if (!cert) throw new ValidationError({\n      status: 403,\n      message: 'No client cert',\n      hint: rquery.hints.signup\n   });\n   const fingerprint = rquery.getClientCertFingerprint(req);\n   const dn = rquery.parseCertDn(req);\n   if (!dn.ou) throw new ValidationError({\n      status: 400,\n      message: 'No client cert OU name',\n      hint: rquery.hints.signup\n   });\n   const [type, account, role, id] = dn.cn.split(':');\n   logger.debug('CN', dn, type, {account, role, id}, {fingerprint});\n   if (type !== 'ws' || !account || !role || !id) {\n      throw new ValidationError({\n         status: 400,\n         message: `Invalid cert CN. Expect: 'ws:account:role:id'`,\n         hint: rquery.hints.signup\n      });\n   }\n   if (dn.ou !== role) {\n      throw new ValidationError({\n         status: 400,\n         message: `Cert OU/role mismatch. Expect role as per CN.`,\n         hint: rquery.hints.signup\n      });\n   }\n   if (dn.o !== account) {\n      throw new ValidationError({\n         status: 400,\n         message: `Cert O/account mismatch. Expect account as per CN.`,\n         hint: rquery.hints.signup\n      });\n   }\n   const accountKey = rquery.adminKey('account', account);\n   const grantKey = rquery.adminKey('telegram', 'user', account, 'grant');\n   const certDigest = rquery.digestPem(cert);\n   const shortDigest = certDigest.slice(-12);\n   logger.debug('cert', certDigest);\n   const [granted, sismember] = await rquery.redis.multiExecAsync(multi => {\n      multi.get(grantKey);\n      multi.sismember(rquery.adminKey('account', account, 'certs'), certDigest);\n   });\n   if (sismember) {\n      throw new ValidationError({\n         status: 200,\n         message: 'Cert already granted',\n         hint: rquery.hints.routes\n      });\n   }\n   if (!granted) {\n      throw new ValidationError({message: `Cert must be granted via https://telegram.me/${rquery.config.adminBotName}`,\n         status: 403,\n         hint: {\n            message: [\n               `/grant ${certDigest}`\n            ].join(' '),\n            clipboard: `/grant ${certDigest}`,\n            url: `https://telegram.me/${rquery.config.adminBotName}?start`\n         }\n      });\n   }\n   if (granted.indexOf(shortDigest) < 0 &&\n   certDigest.indexOf(granted) < 0) {\n      throw new ValidationError({\n         status: 400,\n         message: 'Granted cert not matching: ' + certDigest,\n         hint: {\n            message: `Try @${rquery.config.adminBotName} \"/grant ${certDigest}\"`\n            + ` from the authoritative Telegram account`\n            + ` e.g. via https://web.telegram.org`\n            ,\n            clipboard: `/grant ${certDigest}`,\n            url: `https://telegram.me/${rquery.config.adminBotName}?start`\n         }\n      });\n   }\n   const [del, sadd, hmset] = await rquery.redis.multiExecAsync(multi => {\n      multi.del(grantKey);\n      multi.sadd(rquery.adminKey('account', account, 'certs'), certDigest);\n      multi.hmset(rquery.adminKey('account', account, 'cert', certDigest), {account, role, id});\n   });\n   if (!sadd) {\n      logger.debug('certs sadd');\n   }\n   if (!del) {\n      logger.warn('certs grant del');\n   }\n   return {account};\n}\n"]}
{"version":3,"sources":["../../rquery/handlers/routes.js"],"names":[],"mappings":"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","file":"routes.js","sourcesContent":["\nimport {default as renderPage} from '../html/Page';\nimport {default as renderHelp} from '../html/Help';\n\nconst logger = Loggers.create(module.filename);\nconst rquery = global.rquery;\nassert(rquery.config, 'rquery.config');\n\nmodule.exports = {\n   key: 'routes',\n   access: 'debug',\n   aliases: ['/'],\n   resultObjectType: 'KeyedArrays',\n   sendResult: async (req, res, reqx, result) => {\n      if (rquery.isCliDomain(req)) {\n         return result;\n      } else {\n         res.set('Content-Type', 'text/html');\n         res.send(renderPage(renderHelp({\n            config: rquery.config, req, result, homePath: '/'\n         })));\n      }\n   },\n   handleReq: async (req, res, reqx) => {\n      assert(reqx.command === module.exports, 'command');\n      assert(lodash.isFunction(rquery.isSecureDomain), 'rquery');\n      let hostUrl = rquery.config.hostUrl;\n      if (rquery.config.hostDomain != 'localhost') {\n         hostUrl = 'https://' + req.hostname;\n      }\n      const routes = Express.getRoutes(rquery.expressApp)\n      .filter(route => !['/', '/routes', '/webhook-telegram/*', '/help', '/about'].includes(route));\n      assert(lodash.isArray(routes) && routes.length, 'routes: ' + routes.length);\n      const accountOnlyRoutes = routes\n      .filter(route => route.includes(':account') && !route.includes(':keyspace'));\n      logger.debug('routes', routes.length);\n      let account;\n      try {\n         const dn = req.get('ssl_client_s_dn');\n         if (dn) {\n            const names = rquery.parseDn(dn);\n            if (names.o.match(/^[\\-_a-z]+$/)) {\n               account = names.o;\n            }\n            this.logger.debug('dn', dn, names, account);\n         }\n      } catch (err) {\n         logger.error('cert', err);\n      }\n      const $ = rquery.getContentType(req) === 'html'? He : Hp;\n      return {\n         message: account\n            ? $.a({\n               href: '/keyspaces/' + account\n            }, `List the keyspaces on your account`)\n            : $.a({\n               target: '_blank',\n               href: 'https://telegram.me/redishub_bot'\n            }, `Try \"@${rquery.config.adminBotName}_bot /signup\"`)\n         ,\n         common: routes\n         .filter(route => route)\n         .filter(route => !route.includes(':'))\n         .filter(route => ![\n            '/epoch', '/register-ephemeral'\n         ].includes(route))\n         .filter(route => route !== '/enroll-cert' || rquery.isSecureDomain(req))\n         .filter(route => route !== '/register-cert' || rquery.isSecureDomain(req))\n         .map(route => `${hostUrl}${route}`)\n         ,\n         misc: routes\n         .filter(route => route.includes(':') && !route.includes('telegram') && !/\\:(account|access)/.test(route))\n         .map(route => `${route}`)\n         ,\n         ephemeral: routes\n         .filter(route => route.includes('-ephemeral') && route !== '/register-ephemeral')\n         .map(route => `${route}`)\n         ,\n         telegram: routes\n         .filter(route => route.includes('telegram'))\n         .map(route => `${route}`)\n         ,\n         account: accountOnlyRoutes.map(route => `${route}`)\n         ,\n         accountKeyspace: routes\n         .filter(route => route.includes(':account') && route.includes(':keyspace/'))\n         .map(route => `${route}`)\n      };\n   }\n};\n"]}
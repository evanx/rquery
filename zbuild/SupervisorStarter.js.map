{"version":3,"sources":["../lib/SupervisorStarter.js"],"names":[],"mappings":"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","file":"SupervisorStarter.js","sourcesContent":["\n// messages\n\nvar Messages = require('./SupervisorStarter.messages.js');\n\n// create context for Supervisor and components\n\n// globals\n\nfunction assignLibs(g) {\n   g.assert = require('assert');\n   g.bluebird = require('bluebird');\n   g.bunyan = require('bunyan');\n   g.crypto = require('crypto');\n   g.fs = require('fs');\n   g.http = require('http');\n   g.lodash = require('lodash');\n   g.os = require('os');\n   g.redisLib = require('redis');\n}\n\nfunction assignErrors(g) {\n   g.ApplicationError = function() {\n      this.constructor.prototype.__proto__ = Error.prototype;\n      Error.captureStackTrace(this, this.constructor);\n      this.name = 'ApplicationError';\n      var args = [].slice.call(arguments);\n      if (args.length === 1) {\n         this.message = args[0].toString();\n      } else {\n         this.message = args.toString();\n      }\n   };\n   g.ValidationError = function() {\n      this.constructor.prototype.__proto__ = Error.prototype;\n      Error.captureStackTrace(this, this.constructor);\n      this.name = 'ValidationError';\n      var args = [].slice.call(arguments);\n      if (args.length === 1) {\n         if (args[0].message) {\n            var err = args[0];\n            this.message = err.message;\n            this.hint = err.hint;\n            this.hints = err.hints;\n         } else {\n            this.message = args[0].toString();\n         }\n      } else {\n         this.message = args.toString();\n      }\n   };\n}\n\nassignLibs(global);\nassignErrors(global);\n\n// logging\n\nconst config = {\n   loggerName: 'supervisor',\n   loggerLevel: 'info'\n};\nif (process.env.loggerLevel) {\n   config.loggerLevel = process.env.loggerLevel;\n} else if (process.env.NODE_ENV === 'development') {\n   config.loggerLevel = 'debug';\n}\n\nglobal.loggerLevel = config.loggerLevel;\nif (process.env.loggerUrl) {\n   global.loggerUrl = process.env.loggerUrl;\n}\n\nconst logger = global.bunyan.createLogger({name: config.loggerName, level: config.loggerLevel})\n\n// redis\n\nbluebird.promisifyAll(redisLib.RedisClient.prototype);\nbluebird.promisifyAll(redisLib.Multi.prototype);\nredisLib.RedisClient.prototype.multiExecAsync = function(fn) {\n   var multi = this.multi();\n   fn(multi);\n   return multi.execAsync();\n};\n\n// dependencies\n\nfunction assignDeps(g) {\n   g.Loggers = require('./Loggers');\n   g.Arrays = require('./Arrays');\n   g.Asserts = require('./Asserts');\n   g.ClassPreprocessor = require('./ClassPreprocessor');\n   g.CsonFiles = require('./CsonFiles');\n   g.Files = require('./Files');\n   g.KeyArrays = require('./KeyArrays');\n   g.Metas = require('./Metas');\n   g.Millis = require('./Millis');\n   g.Objects = require('./Objects');\n   g.Promises = require('./Promises');\n   g.Requests = require('./Requests');\n   g.Strings = require('./Strings');\n   g.Values = require('./Values');\n   if (true) { // TODO\n      assignDepsOptional(g);\n   }\n}\n\nfunction assignDepsOptional(g) {\n   g.Styles = require('./Styles');\n   g.HtmlElements = require('./HtmlElements');\n   g.HtmlElements.assignDeps(g);\n   g.If = require('./If');\n}\n\nassignDeps(global);\n\n// supervisor configuration\n\nfunction getSupervisorMeta() {\n   logger.debug('getSupervisorMeta');\n   const componentsConfig = getComponentsConfig();\n   logger.debug('config.spec', componentsConfig.spec);\n   const componentsMeta = CsonFiles.readFileSync('./components.cson');\n   logger.debug('components.spec', componentsMeta.spec);\n   if (!Metas.isSpecType(componentsMeta, 'components')) {\n      throw {message: 'components.cson spec: ' + componentsMeta.spec};\n   }\n   Object.assign(config, {\n      availableComponents: componentsMeta.components,\n      components: componentsConfig.components\n   });\n   return Object.assign(CsonFiles.readFileSync('./lib/Supervisor.cson'), {config: config});\n}\n\nfunction getComponentsConfig() {\n   if (!process.env.configModule) {\n      throw Messages.missingConfigModule();\n   }\n   logger.info('env.configModule', process.env.configModule);\n   const config = require('.' + process.env.configModule);\n   Object.keys(config).forEach(name => {\n      const componentConfig = config[name];\n      Object.keys(componentConfig).forEach(key => {\n         const envKey = name + '_' + key;\n         if (process.env[envKey]) {\n            componentConfig[key] = process.env[envKey];\n         }\n      });\n   });\n   return config;\n}\n\n// supervisor instance\n\nasync function createSupervisor(supervisorMeta) {\n   logger.debug('createSupervisor', supervisorMeta);\n   if (/\\Wicp\\W/.test(supervisorMeta.spec)) { // TODO babel class transform, rather than fragile regex transformation\n      logger.debug('createSupervisor', supervisorMeta.spec);\n      await ClassPreprocessor.buildSync('./lib/Supervisor.js', [\n         'logger', 'context', 'config'\n      ].concat(Object.keys(supervisorMeta.state)));\n   }\n   const Supervisor = require('../zbuild/Supervisor').default;\n   return new Supervisor();\n}\n\nexport async function startSupervisor() {\n   logger.debug('startSupervisor');\n   const supervisorMeta = getSupervisorMeta();\n   logger.debug('supervisor.spec', supervisorMeta.spec);\n   logger.debug('supervisor config', JSON.stringify(supervisorMeta.config, null, 3));\n   const supervisor = await createSupervisor(supervisorMeta);\n   assert(lodash.isFunction(supervisor.init), 'supervisor.init');\n   Object.assign(supervisor, Object.assign({logger: logger, config: supervisorMeta.config}, supervisorMeta.state));\n   try {\n      await supervisor.init();\n      logger.info('started pid', process.pid);\n      process.on('SIGTERM', function() {\n         logger.info('SIGTERM')\n         supervisor.end();\n      });\n   } catch(err) {\n      if (err.errno) {\n         logger.error({err: err.message, errno: err.errno});\n      } else if (err.code) {\n         logger.error({err: err.message, code: err.code});\n      } else if (!err.name) {\n         logger.error(err);\n      } else if (lodash.includes(['TypeError'], err.name)) {\n         logger.error(err);\n      } else if (lodash.includes(['ValidationError', 'ApplicationError', 'AssertionError'], err.name)) {\n         logger.error(err.message);\n      } else {\n         logger.error(err);\n      }\n      supervisor.end();\n   }\n}\n"]}